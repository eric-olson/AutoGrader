<div class="row" style="height: 500px;">
  <div class="col-md-12">
    <div id="status_div">
      <% flash.each do |type, message| %>
        <div class="alert <%= bootstrap_class_for(type) %> fade in">
          <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
          <%= message %>
        </div>
      <% end %>
    </div>
    <h4>Test Results</h4>
    <div id="progress_bar_container" class="progress progress-bar-segmented">
    </div>
  </div>
  <div class="col-md-4">
    <div class="panel panel-default">

      <div class="panel-heading">
        <h3 class="panel-title"><%= @assignment.name %></h3>
      </div>
      <div class="panel-body">
        <%= @assignment.description.html_safe %>

        <div class="btn-group btn-group-justified" role="group" aria-label="...">
          <div class="btn-group" role="group" id="restart_btn">
            <button type="button" class="btn btn-default">Restart</button>
          </div>

          <div class="btn-group" role="group" id="test_btn">
            <button type="button" class="btn btn-default">Test</button>
          </div>

          <div class="btn-group" role="group">
            <button type="button" class="btn btn-default" id="save_btn">Save</button>
          </div>

          <div class="btn-group" role="group">
            <button type="button" class="btn btn-default">Submit</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-8">

    <ul class="nav nav-tabs">
      <li class="active">
        <a href="#1" data-toggle="tab">Write</a>
      </li>
      <li>
        <a href="#2" data-toggle="tab">Upload</a>
      </li>
    </ul>

    <div class="tab-content">
      <div class="tab-pane active" id="1">
        <div id="editor"><%= @editor_file_contents %></div>

        <script>
        function getAnimatedProgressBar() {
          return '<div class="progress-bar progress-bar-striped active" role="progressbar" style="width:100%;background-color: darkcyan;">Running Tests</div>';
        }

        // message can be whatever
        // alert_class must be one of:
        //    alert-success
        //    alert-info
        //    alert-warning
        //    alert-danger
        function buildAlertBox(message, alert_class) {
          autoCloseAlert();
          return '<div class="alert ' + alert_class + ' fade in"><a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>' + message + '</div>'
        }

        function buildAlertBoxSuccess(message) {
          return buildAlertBox(message, "alert-success");
        }

        function buildAlertBoxInfo(message) {
          return buildAlertBox(message, "alert-info");
        }

        function buildAlertBoxWarning(message) {
          return buildAlertBox(message, "alert-warning");
        }

        function buildAlertBoxDanger(message) {
          return buildAlertBox(message, "alert-danger");
        }

        function autoCloseAlert() {
          window.setTimeout(function() {
            $(".alert").fadeTo(2000, 500).slideUp(500, function(){
              $(this).remove();
            });
          }, 2000);
        }

        var editor = ace.edit("editor");
        editor.$blockScrolling = Infinity;

        $( document ).ready(function() {
          autoCloseAlert();
          editor.setTheme("ace/theme/chrome");
          editor.getSession().setMode("ace/mode/c_cpp");
        });

        $('#test_btn').on('click', function() {
          $('#progress_bar_container').html(getAnimatedProgressBar());

          $.ajax({
            type: 'post',
            url: 'testCode',
            data: {editor_text:editor.getValue(),id:<%=@assignment.id%>},
            success: function(response) {
              // Load the progress bar with the html from the response
              $('#progress_bar_container').html(response.progress_bar_html);
              // Enable popovers
              $('[data-toggle="popover"]').popover();
            }
          });
          return false;
        });

        $('#save_btn').on('click', function() {
          $.ajax({
            type: 'post',
            url: 'saveCode',
            data: {editor_text:editor.getValue(),id:<%=@assignment.id%>},
            success: function(response) {
              $('#status_div').html(buildAlertBox("File saved successfully!", "alert-success"));
            }
          });
        });

        $('#restart_btn').on('click', function() {
          $.ajax({
            type: 'post',
            url: 'restartCode',
            data: {editor_text:editor.getValue(),id:<%=@assignment.id%>},
            success: function(response) {
              $('#status_div').html(buildAlertBox("Reset file to the default spec.", "alert-success"));
              editor.setValue(response.new_editor_content, -1);
            }
          });
        });

        </script>
      </div>

      <div class="tab-pane" id="2">
        <%= form_tag({:action => "uploadCode", :id => @assignment.id}, :multipart => true) do %>
        <%= file_field_tag 'assignment_file' %>
        <%= submit_tag "Upload" %>
        <% end %>
      </div>

    </div>
  </div>
</div>
